'use strict';

var _end = require('./lib/end');

var _end2 = _interopRequireDefault(_end);

var _index = require('./user/index');

var _index2 = _interopRequireDefault(_index);

var _index3 = require('./org/index');

var _index4 = _interopRequireDefault(_index3);

var _index5 = require('./group/index');

var _index6 = _interopRequireDefault(_index5);

var _create = require('./group/create');

var _create2 = _interopRequireDefault(_create);

var _index7 = require('./item/index');

var _index8 = _interopRequireDefault(_index7);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Wrapper for arcgis api
 */
var rq = require('./request/index');


var Client = {
  search: function search() {
    var _ref = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    var _ref$queryString = _ref.queryString;
    var queryString = _ref$queryString === undefined ? '""' : _ref$queryString;
    var _ref$num = _ref.num;
    var num = _ref$num === undefined ? 100 : _ref$num;
    var _ref$page = _ref.page;
    var page = _ref$page === undefined ? 0 : _ref$page;
    var _ref$sort = _ref.sort;
    var sort = _ref$sort === undefined ? 'created' : _ref$sort;
    var _ref$order = _ref.order;
    var order = _ref$order === undefined ? 'desc' : _ref$order;
    var cb = arguments[1];

    var startNum = num * page + 1;
    var searchPromise = this.request({
      url: 'search',
      form: { 'q': queryString, 'num': num, start: startNum, sortField: sort, sortOrder: order }
    }).then(function (results) {
      results.currentPage = page;
      results.pages = Math.ceil(results.total / num);
      return results;
    });
    return (0, _end2.default)(searchPromise, cb);
  }
};

var client = function client() {
  var _ref2 = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

  var _ref2$token = _ref2.token;
  var token = _ref2$token === undefined ? '' : _ref2$token;
  var _ref2$domain = _ref2.domain;
  var domain = _ref2$domain === undefined ? 'www.arcgis.com' : _ref2$domain;
  var _ref2$username = _ref2.username;
  var username = _ref2$username === undefined ? null : _ref2$username;
  var _ref2$password = _ref2.password;
  var password = _ref2$password === undefined ? null : _ref2$password;
  var _ref2$enterpriseCredi = _ref2.enterpriseCreditials;
  var enterpriseCreditials = _ref2$enterpriseCredi === undefined ? false : _ref2$enterpriseCredi;

  var arcgis = Object.create(Client);

  arcgis.request = function () {
    var _ref3 = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    var _ref3$url = _ref3.url;
    var url = _ref3$url === undefined ? '/' : _ref3$url;
    var _ref3$form = _ref3.form;
    var form = _ref3$form === undefined ? {} : _ref3$form;
    var _ref3$post = _ref3.post;
    var post = _ref3$post === undefined ? false : _ref3$post;
    var _ref3$rootUrl = _ref3.rootUrl;
    var rootUrl = _ref3$rootUrl === undefined ? 'https://' + domain + '/sharing/rest/' : _ref3$rootUrl;
    var cb = arguments[1];

    if (!form.public) {
      form.token = token;
    }
    form.f = 'pjson';

    var requestPromise;
    if (post) {
      requestPromise = rq.post('' + rootUrl + url, form);
    } else {
      requestPromise = rq.get('' + rootUrl + url, form);
    }

    return (0, _end2.default)(requestPromise, cb);
  };
  arcgis.user = (0, _index2.default)(arcgis);
  arcgis.organization = (0, _index4.default)(arcgis);
  arcgis.group = (0, _index6.default)(arcgis);
  arcgis.group.create = (0, _create2.default)(arcgis);
  arcgis.item = (0, _index8.default)(arcgis);
  arcgis.application = arcgis.item;
  arcgis.layer = arcgis.item;
  arcgis.map = arcgis.item;
  arcgis.file = arcgis.item;
  return arcgis;
};

module.exports = client;